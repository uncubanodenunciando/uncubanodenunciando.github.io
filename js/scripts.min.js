$.ajaxSetup({async:!1});const i18n=new I18n;i18n.load(document.documentElement.lang.split("-")[0]);const PAGE_SIZE=10,PAGINATION_RANGE=3;var cases=[],media={},caseType={};let victimsData=[{id:"sex",get:e=>"Female"===e.sex?`<i class="fa fa-venus"></i> ${i18n.t("Female")}`:`<i class="fa fa-mars"></i> ${i18n.t("Male")}`},{id:"age",get(e){let[t,a]=e.age.split(" ");return`<i class="far fa-clock"></i> ${t} ${i18n.t(a)}`}},{id:"date",get:e=>`<i class="far fa-calendar"></i> ${e.date}`},{id:"location",get:e=>`<i class="fas fa-map-marker-alt pr-1"></i> ${i18n.t(e.location.province)}${"municipality"in e.location?", "+i18n.t(e.location.municipality):""}`},{id:"type",get:e=>`<i class="fas fa-regular fa-gavel pr-1"></i> ${i18n.t(e.type)}`}];function readData(){$.getJSON("/data/db.min.json",function(e){cases=e.cases.sort((e,t)=>e.date!=t.date?e.date<t.date?1:-1:e.name!=t.name?e.name<t.name?-1:1:0),media=e.media,caseType=e.case_type})}function getPageHashParameters(){return window.location.hash.substring(1).split("&").reduce((e,t)=>{var a=t.split("=");return e[a[0]]=a[1],e},{})}function paginate(e){let t=$("#victimsGrid");t.empty();let a=$("#victimsTable > tbody");a.empty();let i=Math.max(0,(e-1)*10),s=Math.min(10*e,cases.length);for(let l=i;l<s;++l){let n=cases[l],o="";"type"in n&&"icon"in caseType[n.type]&&(o=`<div class="thumb"><img class="img-fluid" src="/images/${caseType[n.type].icon}" alt="${i18n.t(n.type)}"></div>`);let d="";for(let r of victimsData)r.id in n&&(d+=`<li>${r.get(n)}</li>`);let c=["",""];for(let[p,_]of["dictatorship","independent"].entries())for(let[m,f]of Object.entries(media[_]))m in n.reports&&(c[p]+=`<a class="text-decoration-none" href="${n.reports[m].link}" target="_blank" data-toggle="tooltip" title="${m}"><img src="/${f.icon}" class="rounded-circle" alt="" style="width: 40px;"></a>`);t.append(`<div class="card mb-2"><div class="card-body"><div class="row"><div class="col-3 text-center"><h5>${cases.length-l}</h5>`+o+'</div><div class="col-9 test-start">'+`<h5>${"name"in n?n.name:"<br>"}</h5>`+'<ul class="fa-ul ms-0 mb-0">'+`${""===d?"<br>":d}`+'</ul></div></div><div class="row"><div class="col-12 mt-1 text-center">'+c[0]+c[1]+"</div></div></div></div>"),a.append(`<tr class="candidates-list"><td class="text-center">${cases.length-l}</td><td>${o}</td><td><div class="candidate-list-details"><div class="candidate-list-info"><div class="candidate-list-title"><h5 class="mb-0">${"name"in n?n.name:"<br>"}</h5></div><div class="candidate-list-option"><ul class="list-unstyled">${""===d?"<br>":d}</ul></div></div></div></td><td class="candidate-list-favourite-time text-center">${c[0]}</td><td class="candidate-list-favourite-time text-center">${c[1]}</td></tr>`)}let u=Math.ceil(cases.length/10),g=e-1,b=g+3-1,h=$("#pagination");if(h.empty(),e<1||e>u){a.append(`<tr><td colspan="5" class="text-center">${i18n.t("error_no_data",{open:'<a href="#page=1" onclick="refreshIndex(1)">',close:"</a>"})}</td></tr>`);return}1<g&&h.append('<li class="page-item"><a class="page-link" href="#page=1" onclick="refreshIndex(1)">1</a></li>'),2<g&&h.append('<li class="page-item disabled"><span class="page-link">&hellip;</span></li>');for(let v=Math.max(1,g);v<=Math.min(b,u);++v)h.append(`<li class="page-item${v==e?" active":""}"><a class="page-link" href="#page=${v}" onclick="refreshIndex(${v})">${v}</a></li>`);b<u-1&&h.append('<li class="page-item disabled"><span class="page-link">&hellip;</span></li>'),b<u&&h.append(`<li class="page-item"><a class="page-link" href="#page=${u}" onclick="refreshIndex(${u})">${u}</a></li>`)}function addStats(){let e=i18n.t("Unknown"),t=["#fd7f6f","#7eb0d5","#b2e061","#bd7ebe","#ffb55a","#ffee65","#beb9db","#fdcce5","#8bd3c7"],a=[["0-17",[0,18]],["18-29",[18,30]],["30-39",[30,40]],["40-49",[40,50]],["50-59",[50,60]],["60+",[60,150]],],i=[{name:i18n.t("January"),id:"01"},{name:i18n.t("February"),id:"02"},{name:i18n.t("March"),id:"03"},{name:i18n.t("April"),id:"04"},{name:i18n.t("May"),id:"05"},{name:i18n.t("June"),id:"06"},{name:i18n.t("July"),id:"07"},{name:i18n.t("August"),id:"08"},{name:i18n.t("September"),id:"09"},{name:i18n.t("October"),id:"10"},{name:i18n.t("November"),id:"11"},{name:i18n.t("December"),id:"12"}],s=("0"+(new Date().getMonth()+1)).slice(-2),l=[{id:"numberVictims",value:0,check:e=>!0},{id:"numberFemaleVictims",value:0,check:e=>"Female"==e.sex},{id:"numberMaleVictims",value:0,check:e=>"Male"==e.sex},{id:"numberMonthVictims",value:0,check:e=>e.date.split("-")[1]==s}],n={},o=0,d={},r={},c={},p={},_={},m={};for(let f of cases){for(let u of l)u.check(f)&&++u.value;let g=(f.location??{}).province??e;g in n?++n[g].total:n[g]={total:1,sex:{}},"sex"in f?(f.sex in n[g].sex?++n[g].sex[f.sex]:n[g].sex[f.sex]=1,d[f.sex]=(d[f.sex]??0)+1):d[e]=(d[e]??0)+1,o=Math.max(o,n[g].total);let b=f.type??e;if(r[b]=(r[b]??0)+1,"age"in f){let[h,v]=f.age.split(" ");for(let[y,[x,k]]of(["day","days","week","weeks","month","months"].indexOf(v)>-1&&(h=0),a))if(x<=h&&h<k){c[y]=(c[y]??0)+1;break}}else c[e]=(c[e]??0)+1;let C=!1,w=!1,B=i18n.t("Independent"),I=i18n.t("Dictatorship");for(let M of Object.keys(f.reports))M in media.independent?C=!0:w=!0,m[M]=(m[M]??0)+1;C&&(p[B]=(p[B]??0)+1),w&&(p[I]=(p[I]??0)+1);let S=Number(f.date.split("-")[1]);_[S]=(_[S]??0)+1}for(let T of l)$(`[data-content=${T.id}]`).html(T.value);let A=[209,210,212],N=[197,30,58,.2],P=[176,9,9,1];function O(e){let t=[],a=(n[e.properties.province]??{}).total??0;if(0==a)t=A;else{a/=o;for(let i=0;i<N.length;++i)t.push(N[i]*(1-a)+P[i]*a)}return{weight:.5,opacity:.8,color:"#f5f1f1",fillOpacity:1,fillColor:`rgba(${t.join(",")})`}}let Z=L.map("map",{center:[21.5,-79.371124],zoomControl:!0,boxZoom:!1,doubleClickZoom:!1,dragging:!0,zoomSnap:.05,keyboard:!1,scrollWheelZoom:!0,touchZoom:!0,bounceAtZoomLimits:!0,zoom:15,layers:[],attributionControl:!1});Z.zoomControl.setPosition("topright"),$.getJSON("/data/cuba_provinces.min.geojson",function(e){let t=L.geoJSON(e.features,{style:O}),a=(t.getBounds().getNorthEast().lat-t.getBounds().getSouthWest().lat)*.05;t.bindTooltip(function(e){let t=e.feature.properties.province;return`<span>${i18n.t(t)} (${(n[t]??{}).total??0})</span>`},{sticky:!0}),t.bindPopup(function(e){let t=e.feature.properties.province,a=n[t]??{},i=`<div class="map-popup-title bg-dark text-white pt-2 pb-2 ps-2">${i18n.t(t)}</div><div class="map-popup-body">${i18n.t("Total")}: ${a.total??0}`;for(let s of Object.keys(a.sex??{}).sort())i+=`<br>${i18n.t(s)}: ${a.sex[s]}`;return`${i}</div>`}),Z.addLayer(t),Z.fitBounds(t.getBounds()),Z.setMaxBounds(t.getBounds().pad(a))});let D=[{selector:"#victimsBySexChart",label:"",data:d},{selector:"#casesByCaseTypeChart",label:"",data:r},{selector:"#victimsByAgeChart",label:"",data:c},{selector:"#reportsByMediaTypeChart",label:"",data:p}];for(let J of D){let R=[],V=[],z=[],E=0;for(let F of Object.keys(J.data).sort())V.push(J.data[F]),R.push(i18n.t(F)),F==e?z.push("#d1d2d4"):z.push(t[E++]);new Chart($(J.selector),{type:"pie",plugins:[ChartDataLabels],data:{labels:R,datasets:[{label:J.label,data:V,backgroundColor:z}]}})}let j=[];for(let G=1;G<=Number(s);++G)j.push(_[G]??0);new Chart($("#victimsByMonthChart"),{type:"line",plugins:[ChartDataLabels],data:{labels:i.map(e=>e.name),datasets:[{label:i18n.t("Victims"),data:j,backgroundColor:t[0],borderColor:t[0],datalabels:{align:"start",anchor:"start"}},]},options:{plugins:{datalabels:{backgroundColor:function(e){return e.dataset.backgroundColor},borderRadius:4,color:"white",font:{weight:"bold"},formatter:Math.round,padding:6}},aspectRatio:5/3,layout:{padding:{top:32,right:16,bottom:16,left:8}},elements:{line:{fill:!1,tension:.1}},scales:{y:{stacked:!0,beginAtZero:!0,ticks:{callback:function(e){if(e%1==0)return e}}}}}});let H=[],W=[];for(let U in media)for(let q in media[U])W.push(q);for(let[K,Q]of(W.sort(),W.entries()))H.push({label:i18n.t(Q),data:[m[Q]??0],backgroundColor:t[K],borderColor:t[K],datalabels:{align:"start",anchor:"end"}});new Chart($("#reportsByMediaChart"),{type:"bar",plugins:[ChartDataLabels],data:{labels:[i18n.t("Reports")],datasets:H},options:{plugins:{datalabels:{color:"white",display:function(e){return e.dataset.data[e.dataIndex]},font:{weight:"bold"},formatter:Math.round}},aspectRatio:5/3,layout:{padding:{top:24,right:16,bottom:0,left:8}},elements:{line:{fill:!1},point:{hoverRadius:7,radius:5}}}})}function refreshIndex(e){$(window).scrollTop($("#tableView").offset().top-70),paginate(e)}function initializeIndex(){readData();paginate(getPageHashParameters().page??1),addStats()}